---
title: "Assignment"
subtitle: "Introduction to R"
author: "Kevin Hoang"
date: "2025-12-17"
execute:
  echo: false
format: 
  html:
    code-links:
      repo: "https://github.com/kevinoverflow/london_marathon_assignment"
editor:
  markdown:
    wrap: sentence
bibliography: references.bib
---

------------------------------------------------------------------------

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
library(here)
library(dplyr)
library(ggplot2)
library(plotly)
library(scales)
library(ggrepel)

marathon_data <- read.csv(here("london_marathon.csv"))
winners <- read.csv(here("winners.csv"))

# Merge the datasets
marathon_full <- left_join(marathon_data, winners, by = "Year")

min_year <- min(marathon_data$Year, na.rm = TRUE)
max_year <- max(marathon_data$Year, na.rm = TRUE)

n_years <- max_year - min_year + 1
n_winners <- n_distinct(winners$Athlete)
n_countries <- n_distinct(winners$Nationality)
categories <- paste(unique(winners$Category), collapse = ", ")
```

# Introduction

The London Marathon is one of the world’s most iconic long-distance running events, attracting participants and spectators from across the globe. This assignment analyses data from the London Marathon [@LondonMarathon] from `r min_year` to `r max_year`. Over `r n_years` years, `r n_winners` athletes won the marathon across the categories `r categories`, representing `r n_countries` different countries.

The analysis focuses on participation trends, dropout rates, winning times across different categories, and the relationship between the number of starters and the amount of money raised for charity.

The analysis and visualizations were performed using several R packages: `here` [@here], `dplyr` [@dplyr], `ggplot2` [@ggplot2], `plotly` [@plotly], `scales` [@scales], and `ggrepel` [@ggrepel].

------------------------------------------------------------------------

# Participation

We analyze the relations between applicants, accepted, starters, and finishers.

```{r}
# Use merged data, distinct by year for participation metrics
participation_data <- marathon_full %>% distinct(Year, .keep_all = TRUE)

# Plot all in one graph
p1 <- ggplot(participation_data, aes(x = Year)) +
  geom_line(aes(y = Applicants, color = "Applicants")) +
  geom_point(aes(y = Applicants, color = "Applicants")) +
  
  geom_line(aes(y = Accepted, color = "Accepted")) +
  geom_point(aes(y = Accepted, color = "Accepted")) +

  
  geom_line(aes(y = Starters, color = "Starters")) +
  geom_point(aes(y = Starters, color = "Starters")) +
  
  geom_line(aes(y = Finishers, color = "Finishers")) +
  geom_point(aes(y = Finishers, color = "Finishers")) +

  scale_y_continuous(labels = comma) +
  labs(title = "Participation Metrics Over Time",
       x = "Year",
       y = "Number of People",
       color = "Metric") +
  theme_minimal()

ggplotly(p1)
```

The number of applicants has been rising rapidly over the years, indicating growing interest in the marathon.
However, the number of starters has grown more slowly, suggesting that not all accepted applicants actually participate, due to acceptance requirements.

```{r}
# Calculate average slope
applicants_lm <- lm(Applicants ~ Year, data = participation_data)
starters_lm <- lm(Starters ~ Year, data = participation_data)

slopes <- c(
  applicants = summary(applicants_lm)$coefficients[2,1],
  starters = summary(starters_lm)$coefficients[2,1]
)
```

The average slope for applicants is `r round(slopes[1], 2)`, while for starters it's `r round(slopes[2], 2)`, confirming faster growth in applicants.

------------------------------------------------------------------------

# Dropout rate

The dropout rate over the years:

```{r}
participation_data <- participation_data %>%
  mutate(Dropout_Rate = (Starters - Finishers) / Starters * 100)

p2 <- ggplot(participation_data, aes(x = Year, y = Dropout_Rate)) +
  geom_line() +
  geom_point() + 
  labs(title = "Dropout Rate Over Time", x = "Year", y = "Dropout Rate (%)") +
  theme_minimal()

ggplotly(p2)
```

Dropout rates vary across the years, peaking in 2020 due to the low number of starters that year.
With only 77 participants, the 16 dropouts resulted in a high percentage.

```{r}
# Get 2020 dropout rate
dropout_2020 <- participation_data %>% filter(Year == 2020) %>% pull(Dropout_Rate)

# Calculate average dropout rate without 2020
dropout_avg <- participation_data %>% filter(Year != 2020) %>% summarise(mean = mean(Dropout_Rate, na.rm = TRUE)) %>% pull(mean)
```

The dropout rate in 2020 was `r round(dropout_2020, 2)`%, compared to an average of `r round(dropout_avg, 2)`% in other years, showing a significant increase.

------------------------------------------------------------------------

# Winning Times

Winning Times Over Time by Category

```{r}
# Convert time to hours for better readability
marathon_full <- marathon_full %>% mutate(Time_hours = Time * 24)

p3 <- ggplot(marathon_full, aes(x = Year, y = Time_hours, color = Category)) +
  geom_line() +
  geom_point() +
  labs(title = "Winning Times Over Time", x = "Year", y = "Time (hours)") +
  theme_minimal()

ggplotly(p3)
```

Winning times for men and women have remained relatively consistent over the years, with gradual improvements.
In contrast, wheelchair categories show significant improvements, with times getting faster, reflecting advancements in technology and training for athletes with disabilities.

```{r}
# Calculate average slope of winning times
marathon_full <- marathon_full %>% mutate(Time_hours = Time * 24)
men_lm <- lm(Time_hours ~ Year, data = marathon_full %>% filter(Category == "Men"))
women_lm <- lm(Time_hours ~ Year, data = marathon_full %>% filter(Category == "Women"))
wheelchair_men_lm <- lm(Time_hours ~ Year, data = marathon_full %>% filter(Category == "Wheelchair Men"))
wheelchair_women_lm <- lm(Time_hours ~ Year, data = marathon_full %>% filter(Category == "Wheelchair Women"))

slopes <- c(
  Men = summary(men_lm)$coefficients[2,1],
  Women = summary(women_lm)$coefficients[2,1],
  "Wheelchair Men" = summary(wheelchair_men_lm)$coefficients[2,1],
  "Wheelchair Women" = summary(wheelchair_women_lm)$coefficients[2,1]
)
slopes
```

### The yearly improvements in winning times are:  

| Category           | Annual Improvement (sec/year) |
|-------------------|-------------------------------|
| Men               | `r round(abs(slopes["Men"]) * 3600, 0)` |
| Women             | `r round(abs(slopes["Women"]) * 3600, 0)` |
| Wheelchair Men    | `r round(abs(slopes["Wheelchair Men"]) * 3600, 0)` |
| Wheelchair Women  | `r round(abs(slopes["Wheelchair Women"]) * 3600, 0)` |

Overall, wheelchair categories show the most  improvements, reflecting progress in technology and training for athletes with disabilities, while men’s and women’s running times have remained relatively consistent with gradual gains. 

Wheelchair categories show greater improvements compared to running categories.

------------------------------------------------------------------------

# Participation vs Charity Raised

```{r}
p4 <- ggplot(participation_data, aes(
  x = Starters,
  y = Raised,
  size = Raised,
  text = paste("Year:", Year,
               "<br>Starters:", comma(Starters),
               "<br>Raised: £", Raised, "million")
)) +
  geom_point() +
  scale_size_continuous(name = "Charity Raised (£ millions)", labels = comma) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(labels = comma) +
  labs(
    title = "Participation vs Charity Raised",
    x = "Number of Starters",
    y = "Charity Raised (£ millions)"
  ) +
  theme_minimal()

ggplotly(p4, tooltip = "text")
```


```{r}
cor_test <- cor.test(participation_data$Starters, participation_data$Raised, use = "complete.obs")
cor_test$estimate
cor_test$p.value   
```

There is a strong positive correlation (r = `r round(cor_test$estimate, 2)`, p < 0.001) between the number of participants and the amount of money raised for charity. Years with more starters tend to raise significantly more funds, showing that higher participation directly contributes to greater charitable impact. This highlights the marathon’s success in engaging the community, where larger crowds translate into more financial support for the causes involved.

------------------------------------------------------------------------

# References 
::: {#refs}
:::